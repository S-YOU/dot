#!/bin/bash

echomsg() {
    echo -ne "\x1b[0;32m"; echo "$@"; echo -ne "\x1b[0m"
}

echoquestion() {
    echo -ne "\x1b[1;33m"; echo "$@"; echo -ne "\x1b[0m"
}

# ~/.gitconfigを読みこまないようにする
# もっといい方法はないか？
OLD_HOME=$HOME
export HOME=/

TMP=/tmp/gita.tmp.$$

cat > $TMP <<EOF
#!/bin/sh

EOF

# ファイル一覧を一時ファイルに保存
git -c core.excludesfile=$OLD_HOME/.gitignore -c color.ui=never status --short | awk '$0 !~ /^( D|D )/ {print}' >> $TMP
cp -a $TMP $TMP.orig
# 一時ファイルの更新日時を古くしておく（そうしないと、エディタ起動して即保存終了したとき変更が検出されない）
touch -t 200001010000 $TMP

HOME="$OLD_HOME" vim $TMP

# 一時ファイルの更新日時が新しくなっていたら（エディタで保存されていたら）
if [ $TMP -nt $TMP.orig ]; then
    HOME=$OLD_HOME
    cat $TMP
    echoquestion "実行しますか？ (y/N)"
    read ans
    case "$ans" in
        y|Y)
            bash -x $TMP
            ;;
        *)
            echomsg "キャンセルしました"
            ;;
    esac
else
    echomsg "何もしません"
fi
